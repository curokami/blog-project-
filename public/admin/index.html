<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <link rel="stylesheet" href="https://unpkg.com/decap-cms-app@3.9.0/dist/decap-cms-app.css" />
</head>
<body>
  <div id="nc-root"></div>
  
  <!-- Decap CMSスクリプトを読み込む -->
  <script src="https://unpkg.com/decap-cms-app@3.9.0/dist/decap-cms-app.js"></script>
  
  <script>
    (function() {
      // カスタム認証プロバイダー
      class CustomAuth {
        constructor(auth_url = "/api/auth") {
          this.auth_url = auth_url;
          this.authWindow = null;
          this.authPromise = null;
          this.token = null;
          this.checkClosedInterval = null;
        }

        authenticate() {
          this.authPromise = null;
          
          if (this.checkClosedInterval) {
            clearInterval(this.checkClosedInterval);
            this.checkClosedInterval = null;
          }
          
          return new Promise((resolve, reject) => {
            this.authPromise = resolve;
            
            const authCallback = this.authCallback.bind(this);
            window.removeEventListener("message", authCallback, false);
            window.addEventListener("message", authCallback, false);
            
            const auth_url = `${this.auth_url}?provider=github&site_id=${window.location.host}`;
            
            console.log('Opening auth window:', auth_url);
            this.authWindow = window.open(auth_url, "auth", "width=600,height=600");
            
            if (!this.authWindow) {
              reject(new Error("ポップアップがブロックされました。ポップアップブロッカーを無効にしてください。"));
              return;
            }
            
            this.checkClosedInterval = setInterval(() => {
              if (this.authWindow?.closed) {
                if (this.checkClosedInterval) {
                  clearInterval(this.checkClosedInterval);
                  this.checkClosedInterval = null;
                }
                if (this.authPromise) {
                  window.removeEventListener("message", authCallback, false);
                  this.authPromise = null;
                  reject(new Error("認証ウィンドウが閉じられました"));
                }
              }
            }, 1000);
          });
        }

        authCallback(event) {
          console.log('Received message event:', {
            origin: event.origin,
            expectedOrigin: window.location.origin,
            data: event.data
          });
          
          if (event.origin !== window.location.origin) {
            console.warn(`Ignored message from different origin: ${event.origin} (expected: ${window.location.origin})`);
            return;
          }
          
          if (event.data && event.data.type === 'authorization_response' && event.data.payload && event.data.payload.token) {
            if (this.checkClosedInterval) {
              clearInterval(this.checkClosedInterval);
              this.checkClosedInterval = null;
            }
            
            this.token = event.data.payload.token;
            console.log('Authentication successful, token received');
            
            if (this.authPromise) {
              this.authPromise(true);
              this.authPromise = null;
            }
            this.cleanup();
          } else {
            console.warn('Invalid message format:', event.data);
          }
        }

        cleanup() {
          if (this.authWindow) {
            this.authWindow.close();
          }
          window.removeEventListener("message", this.authCallback.bind(this));
        }

        async getUser() {
          if (!this.token) {
            console.error("getUser called but no token available");
            throw new Error("Not authenticated");
          }

          console.log("Fetching user info from GitHub API");
          const res = await fetch("https://api.github.com/user", {
            headers: {
              Authorization: `Bearer ${this.token}`,
              Accept: "application/vnd.github.v3+json",
            },
          });

          if (!res.ok) {
            console.error("GitHub API error:", res.status, res.statusText);
            const err = await res.json();
            console.error("GitHub API error details:", err);
            throw err;
          }

          const data = await res.json();
          console.log("User info retrieved:", data.login);
          return {
            name: data.name || data.login,
            login: data.login,
            avatar_url: data.avatar_url,
          };
        }

        logout() {
          this.token = null;
          return Promise.resolve();
        }

        getToken() {
          return Promise.resolve(this.token);
        }
      }

      // CMSオブジェクトを待つ関数
      function waitForCMS(callback, maxAttempts = 100) {
        let attempts = 0;
        
        function check() {
          // 複数の可能性のあるグローバル変数を確認
          const CMS = window.CMS || window.DecapCMS || window.NETLIFY_CMS;
          
          if (CMS && typeof CMS.registerBackend === 'function' && typeof CMS.init === 'function') {
            console.log('✓ CMS found and ready');
            callback(CMS);
          } else if (attempts < maxAttempts) {
            attempts++;
            setTimeout(check, 50);
          } else {
            console.error('✗ CMS not found after maximum attempts');
            const root = document.getElementById('nc-root');
            if (root) {
              root.innerHTML = '<div style="padding: 40px; text-align: center; font-family: system-ui, sans-serif;"><h1 style="color: #e74c3c; margin-bottom: 20px;">エラー</h1><p style="color: #333; margin-bottom: 20px;">Decap CMSが読み込まれていません。</p><p style="color: #666; font-size: 14px; margin-bottom: 20px;">スクリプトの読み込みを確認してください。</p><button onclick="location.reload()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">ページを再読み込み</button></div>';
            }
          }
        }
        
        check();
      }

      // CMSが読み込まれたら初期化
      waitForCMS(function(CMS) {
        try {
          console.log('Registering custom backend...');
          // カスタムバックエンドを登録
          CMS.registerBackend("github", CustomAuth);
          console.log('✓ Custom backend registered');
          
          // CMSを初期化（config.ymlを自動的に読み込む）
          console.log('Initializing CMS...');
          CMS.init();
          console.log('✓ Decap CMS initialized successfully');
        } catch (error) {
          console.error('✗ Failed to initialize CMS:', error);
          const root = document.getElementById('nc-root');
          if (root) {
            root.innerHTML = '<div style="padding: 40px; text-align: center; font-family: system-ui, sans-serif;"><h1 style="color: #e74c3c; margin-bottom: 20px;">エラー</h1><p style="color: #333; margin-bottom: 20px;">' + error.message + '</p><pre style="text-align: left; background: #f5f5f5; padding: 20px; border-radius: 4px; overflow: auto; max-width: 800px; margin: 0 auto;">' + error.stack + '</pre></div>';
          }
        }
      });
    })();
  </script>
</body>
</html>