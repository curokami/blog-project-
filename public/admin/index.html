<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
</head>
<body>
  <div id="nc-root"></div>
  
  <!-- Decap CMSスクリプトをunpkg CDNから読み込む（フォールバック付き） -->
  <script>
    // 複数のCDNを試す
    const cdnUrls = [
      'https://unpkg.com/decap-cms-app@3.9.0/dist/decap-cms-app.js',
      'https://cdn.jsdelivr.net/npm/decap-cms-app@3.9.0/dist/decap-cms-app.js',
      'https://cdn.skypack.dev/decap-cms-app@3.9.0'
    ];
    
    let currentIndex = 0;
    
    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = () => {
          console.log('✓ Script loaded from:', url);
          resolve();
        };
        script.onerror = () => {
          console.error('✗ Failed to load from:', url);
          reject();
        };
        document.head.appendChild(script);
      });
    }
    
    async function tryLoadCMS() {
      while (currentIndex < cdnUrls.length) {
        try {
          await loadScript(cdnUrls[currentIndex]);
          // スクリプト読み込み後、少し待ってからCMSオブジェクトを確認
          setTimeout(() => {
            const CMS = window.CMS || window.DecapCMS || window.NETLIFY_CMS || window.netlifyCMS || window.decapCMS;
            if (CMS) {
              console.log('✓ CMS object found after loading from:', cdnUrls[currentIndex]);
            } else {
              console.warn('⚠ CMS object not found after loading from:', cdnUrls[currentIndex]);
            }
          }, 2000);
          break;
        } catch (error) {
          currentIndex++;
          if (currentIndex >= cdnUrls.length) {
            console.error('✗ All CDN attempts failed');
            handleScriptError();
          }
        }
      }
    }
    
    tryLoadCMS();
  </script>
  
  <script>
    // スクリプト読み込みエラーハンドラ
    function handleScriptError() {
      console.error('✗ Failed to load decap-cms-app.js from all CDNs');
      document.getElementById('nc-root').innerHTML = '<div style="padding: 40px; text-align: center; font-family: system-ui, sans-serif;"><h1 style="color: #e74c3c; margin-bottom: 20px;">エラー</h1><p style="color: #333; margin-bottom: 20px;">Decap CMSスクリプトの読み込みに失敗しました。</p><p style="color: #666; font-size: 14px; margin-bottom: 20px;">ネットワークタブでスクリプトの読み込み状況を確認してください。</p></div>';
    }
    
    // カスタム認証プロバイダー
    class CustomAuth {
      constructor(auth_url = "/api/auth") {
        this.auth_url = auth_url;
        this.authWindow = null;
        this.authPromise = null;
        this.token = null;
        this.checkClosedInterval = null;
      }

      authenticate() {
        this.authPromise = null;
        
        if (this.checkClosedInterval) {
          clearInterval(this.checkClosedInterval);
          this.checkClosedInterval = null;
        }
        
        return new Promise((resolve, reject) => {
          this.authPromise = resolve;
          
          const authCallback = this.authCallback.bind(this);
          window.removeEventListener("message", authCallback, false);
          window.addEventListener("message", authCallback, false);
          
          const auth_url = `${this.auth_url}?provider=github&site_id=${window.location.host}`;
          
          console.log('Opening auth window:', auth_url);
          this.authWindow = window.open(auth_url, "auth", "width=600,height=600");
          
          if (!this.authWindow) {
            reject(new Error("ポップアップがブロックされました。ポップアップブロッカーを無効にしてください。"));
            return;
          }
          
          this.checkClosedInterval = setInterval(() => {
            if (this.authWindow?.closed) {
              if (this.checkClosedInterval) {
                clearInterval(this.checkClosedInterval);
                this.checkClosedInterval = null;
              }
              if (this.authPromise) {
                window.removeEventListener("message", authCallback, false);
                this.authPromise = null;
                reject(new Error("認証ウィンドウが閉じられました"));
              }
            }
          }, 1000);
        });
      }

      authCallback(event) {
        console.log('Received message event:', {
          origin: event.origin,
          expectedOrigin: window.location.origin,
          data: event.data
        });
        
        if (event.origin !== window.location.origin) {
          console.warn(`Ignored message from different origin: ${event.origin} (expected: ${window.location.origin})`);
          return;
        }
        
        if (event.data && event.data.type === 'authorization_response' && event.data.payload && event.data.payload.token) {
          if (this.checkClosedInterval) {
            clearInterval(this.checkClosedInterval);
            this.checkClosedInterval = null;
          }
          
          this.token = event.data.payload.token;
          console.log('Authentication successful, token received');
          
          if (this.authPromise) {
            this.authPromise(true);
            this.authPromise = null;
          }
          this.cleanup();
        } else {
          console.warn('Invalid message format:', event.data);
        }
      }

      cleanup() {
        if (this.authWindow) {
          this.authWindow.close();
        }
        window.removeEventListener("message", this.authCallback.bind(this));
      }

      async getUser() {
        if (!this.token) {
          console.error("getUser called but no token available");
          throw new Error("Not authenticated");
        }

        console.log("Fetching user info from GitHub API");
        const res = await fetch("https://api.github.com/user", {
          headers: {
            Authorization: `Bearer ${this.token}`,
            Accept: "application/vnd.github.v3+json",
          },
        });

        if (!res.ok) {
          console.error("GitHub API error:", res.status, res.statusText);
          const err = await res.json();
          console.error("GitHub API error details:", err);
          throw err;
        }

        const data = await res.json();
        console.log("User info retrieved:", data.login);
        return {
          name: data.name || data.login,
          login: data.login,
          avatar_url: data.avatar_url,
        };
      }

      logout() {
        this.token = null;
        return Promise.resolve();
      }

      getToken() {
        return Promise.resolve(this.token);
      }
    }

    // Decap CMSを初期化
    function initializeCMS() {
      console.log('=== Initializing Decap CMS ===');
      console.log('window object keys:', Object.keys(window).filter(k => 
        k.includes('CMS') || k.includes('Decap') || k.includes('NETLIFY') || k.includes('React') || k.includes('ReactDOM')
      ));
      
      // すべての可能なグローバル変数を確認
      const CMS = window.CMS || window.DecapCMS || window.NETLIFY_CMS || window.netlifyCMS || window.decapCMS;
      
      console.log('window.CMS:', typeof window.CMS, window.CMS);
      console.log('window.DecapCMS:', typeof window.DecapCMS, window.DecapCMS);
      console.log('window.NETLIFY_CMS:', typeof window.NETLIFY_CMS, window.NETLIFY_CMS);
      console.log('window.netlifyCMS:', typeof window.netlifyCMS, window.netlifyCMS);
      console.log('window.decapCMS:', typeof window.decapCMS, window.decapCMS);
      
      if (!CMS) {
        console.error('✗ CMS object not found');
        console.error('All window properties:', Object.keys(window).slice(0, 100));
        document.getElementById('nc-root').innerHTML = '<div style="padding: 40px; text-align: center; font-family: system-ui, sans-serif;"><h1 style="color: #e74c3c; margin-bottom: 20px;">エラー</h1><p style="color: #333; margin-bottom: 20px;">Decap CMSオブジェクトが見つかりません。</p><p style="color: #666; font-size: 14px; margin-bottom: 20px;">コンソールログを確認してください。</p><button onclick="location.reload()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">ページを再読み込み</button></div>';
        return;
      }

      console.log('✓ CMS object found:', CMS);
      console.log('CMS type:', typeof CMS);
      console.log('CMS constructor:', CMS.constructor);
      console.log('CMS methods:', Object.keys(CMS).filter(k => typeof CMS[k] === 'function').slice(0, 20));
      console.log('CMS properties:', Object.keys(CMS).slice(0, 20));
      
      try {
        // カスタムバックエンドを登録（CMS.init()の前に実行）
        if (typeof CMS.registerBackend === 'function') {
          console.log('Registering custom backend...');
          CMS.registerBackend("github", CustomAuth);
          console.log('✓ Custom backend registered');
        } else {
          console.error('✗ CMS.registerBackend is not a function');
          console.error('Available methods:', Object.keys(CMS).filter(k => typeof CMS[k] === 'function'));
          document.getElementById('nc-root').innerHTML = '<div style="padding: 40px; text-align: center; font-family: system-ui, sans-serif;"><h1 style="color: #e74c3c; margin-bottom: 20px;">エラー</h1><p style="color: #333; margin-bottom: 20px;">CMS.registerBackendが見つかりません。</p><p style="color: #666; font-size: 14px;">利用可能なメソッド: ' + Object.keys(CMS).filter(k => typeof CMS[k] === 'function').join(', ') + '</p></div>';
          return;
        }
        
        // CMSを初期化（config.ymlを自動的に読み込む）
        if (typeof CMS.init === 'function') {
          console.log('Initializing CMS...');
          CMS.init();
          console.log('✓ Decap CMS initialized successfully');
        } else {
          console.error('✗ CMS.init is not a function');
          console.error('Available methods:', Object.keys(CMS).filter(k => typeof CMS[k] === 'function'));
          document.getElementById('nc-root').innerHTML = '<div style="padding: 40px; text-align: center; font-family: system-ui, sans-serif;"><h1 style="color: #e74c3c; margin-bottom: 20px;">エラー</h1><p style="color: #333; margin-bottom: 20px;">CMS.initが見つかりません。</p><p style="color: #666; font-size: 14px;">利用可能なメソッド: ' + Object.keys(CMS).filter(k => typeof CMS[k] === 'function').join(', ') + '</p></div>';
        }
      } catch (error) {
        console.error('✗ Failed to initialize CMS:', error);
        console.error('Error name:', error.name);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        document.getElementById('nc-root').innerHTML = '<div style="padding: 40px; text-align: center; font-family: system-ui, sans-serif;"><h1 style="color: #e74c3c; margin-bottom: 20px;">エラー</h1><p style="color: #333; margin-bottom: 20px;">' + error.message + '</p><pre style="text-align: left; background: #f5f5f5; padding: 20px; border-radius: 4px; overflow: auto; max-width: 800px; margin: 0 auto; font-size: 12px;">' + error.stack + '</pre></div>';
      }
    }

    // スクリプトの読み込み完了を待つ
    function waitForScript() {
      let attempts = 0;
      const maxAttempts = 200; // 10秒（50ms * 200）
      
      function check() {
        // CMSオブジェクトを確認（すべての可能性をチェック）
        const CMS = window.CMS || window.DecapCMS || window.NETLIFY_CMS || window.netlifyCMS || window.decapCMS;
        
        if (CMS && typeof CMS.registerBackend === 'function' && typeof CMS.init === 'function') {
          console.log('✓ CMS is ready');
          initializeCMS();
        } else if (attempts < maxAttempts) {
          attempts++;
          if (attempts % 20 === 0) {
            console.log(`Waiting for CMS... (${attempts}/${maxAttempts})`);
            console.log('Checking window.CMS:', typeof window.CMS);
            console.log('Checking window.DecapCMS:', typeof window.DecapCMS);
            console.log('Checking window.NETLIFY_CMS:', typeof window.NETLIFY_CMS);
          }
          setTimeout(check, 50);
        } else {
          console.error('✗ CMS not found after maximum attempts');
          console.error('Script loaded?', document.querySelector('script[src*="decap-cms-app"]') !== null);
          console.error('All window properties related to CMS:', Object.keys(window).filter(k => 
            k.toLowerCase().includes('cms') || k.toLowerCase().includes('decap') || k.toLowerCase().includes('netlify')
          ));
          document.getElementById('nc-root').innerHTML = '<div style="padding: 40px; text-align: center; font-family: system-ui, sans-serif;"><h1 style="color: #e74c3c; margin-bottom: 20px;">エラー</h1><p style="color: #333; margin-bottom: 20px;">Decap CMSが読み込まれていません。</p><p style="color: #666; font-size: 14px; margin-bottom: 20px;">スクリプトの読み込みを確認してください。</p><button onclick="location.reload()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">ページを再読み込み</button></div>';
        }
      }
      
      // window.onload後にチェック開始
      if (document.readyState === 'complete') {
        setTimeout(check, 100);
      } else {
        window.addEventListener('load', function() {
          setTimeout(check, 100);
        });
      }
    }
    
    // スクリプトの読み込みを待つ
    waitForScript();
  </script>
</body>
</html>