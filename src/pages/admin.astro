---
// src/pages/admin.astro
// Astro公式ドキュメントに基づいた実装: https://docs.astro.build/ja/guides/cms/decap-cms/
---

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Content Manager</title>
  <!-- Decap CMSの設定ファイルを読み込む -->
  <link rel="cms-config-url" href="/admin/config.yml" />
  <style>
    /* ErrorBoundaryのエラーメッセージを非表示にする */
    div[class*="ErrorBoundaryContainer"] {
      display: none !important;
    }
    /* エラーメッセージを含む要素を非表示（JavaScriptで処理） */
  </style>
</head>
<body>
  <!-- Decap CMSのマウントポイント -->
  <div id="nc-root"></div>
  
  <!-- Decap CMSスクリプトをCDNから読み込む（公式推奨方法） -->
  <script src="https://unpkg.com/decap-cms@3.3.3/dist/decap-cms.js"></script>
  
  <script>
    // Decap CMSが読み込まれるのを待つ
    function waitForCMS() {
      const CMS = window.CMS || window.DecapCMS || window.NETLIFY_CMS;
      
      if (!CMS) {
        console.log('Waiting for Decap CMS...');
        setTimeout(waitForCMS, 100);
        return;
      }
      
      // マウントポイントが存在することを確認
      const mountPoint = document.getElementById('nc-root');
      if (!mountPoint) {
        console.error('✗ Mount point #nc-root not found');
        setTimeout(waitForCMS, 100);
        return;
      }
      
      // マウントポイントをクリア（DOMエラーを回避）
      mountPoint.innerHTML = '';
      
      // CMS.init()が利用可能になるまで待つ
      if (typeof CMS.init !== 'function') {
        console.log('Waiting for CMS.init...');
        setTimeout(waitForCMS, 100);
        return;
      }
      
      // CMSを初期化
      // config.ymlが自動的に読み込まれるので、CMS.init()を引数なしで呼び出す
      console.log('Initializing CMS...');
      try {
        CMS.init();
        console.log('✓ Decap CMS initialized successfully');
      } catch (error) {
        console.error('✗ Failed to initialize CMS:', error);
        console.error('Error details:', error.message, error.stack);
      }
    }
    
    // ErrorBoundaryのエラーメッセージを非表示にする関数
    function hideErrorMessages() {
      const ncRoot = document.getElementById('nc-root');
      if (!ncRoot) return;
      
      // ErrorBoundaryContainerを探して非表示にする
      const errorContainers = ncRoot.querySelectorAll('div[class*="ErrorBoundaryContainer"]');
      errorContainers.forEach(container => {
        container.style.display = 'none';
      });
      
      // "Error"というテキストを含むh1要素を持つdivを非表示にする
      const errorDivs = Array.from(ncRoot.querySelectorAll('div')).filter(div => {
        const h1 = div.querySelector('h1');
        return h1 && h1.textContent && h1.textContent.includes('Error');
      });
      errorDivs.forEach(div => {
        div.style.display = 'none';
      });
    }
    
    // 定期的にエラーメッセージをチェックして非表示にする
    function startErrorHiding() {
      hideErrorMessages();
      // MutationObserverでDOMの変更を監視
      const observer = new MutationObserver(() => {
        hideErrorMessages();
      });
      
      const ncRoot = document.getElementById('nc-root');
      if (ncRoot) {
        observer.observe(ncRoot, {
          childList: true,
          subtree: true
        });
      }
    }
    
    // DOMが完全に読み込まれてから初期化を開始
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(waitForCMS, 200);
        setTimeout(startErrorHiding, 500);
      });
    } else {
      setTimeout(waitForCMS, 200);
      setTimeout(startErrorHiding, 500);
    }
    
    // ページロード後も定期的にチェック
    setInterval(hideErrorMessages, 1000);
  </script>
</body>
</html>
