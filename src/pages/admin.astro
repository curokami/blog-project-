---
// src/pages/admin.astro
// Astro公式ドキュメントに基づいた実装: https://docs.astro.build/ja/guides/cms/decap-cms/
---

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Content Manager</title>
</head>
<body>
  <!-- Decap CMSのマウントポイント -->
  <div id="nc-root"></div>
  
  <!-- Decap CMSスクリプトをCDNから読み込む（公式推奨方法） -->
  <!-- 最新の安定版を使用（DOMエラーの修正が含まれている可能性） -->
  <script src="https://unpkg.com/decap-cms@latest/dist/decap-cms.js"></script>
  
  <script>
    // カスタム認証プロバイダー（GitHub OAuth用）
    class CustomAuth {
      constructor(auth_url = "/api/auth") {
        this.auth_url = auth_url;
        this.authWindow = null;
        this.authPromise = null;
        this.token = null;
        this.checkClosedInterval = null;
      }

      authenticate() {
        this.authPromise = null;
        
        if (this.checkClosedInterval) {
          clearInterval(this.checkClosedInterval);
          this.checkClosedInterval = null;
        }
        
        return new Promise((resolve, reject) => {
          this.authPromise = resolve;
          
          const authCallback = this.authCallback.bind(this);
          window.removeEventListener("message", authCallback, false);
          window.addEventListener("message", authCallback, false);
          
          const auth_url = `${this.auth_url}?provider=github&site_id=${window.location.host}`;
          
          console.log('Opening auth window:', auth_url);
          this.authWindow = window.open(auth_url, "auth", "width=600,height=600");
          
          if (!this.authWindow) {
            reject(new Error("ポップアップがブロックされました。ポップアップブロッカーを無効にしてください。"));
            return;
          }
          
          this.checkClosedInterval = setInterval(() => {
            if (this.authWindow?.closed) {
              if (this.checkClosedInterval) {
                clearInterval(this.checkClosedInterval);
                this.checkClosedInterval = null;
              }
              if (this.authPromise) {
                window.removeEventListener("message", authCallback, false);
                this.authPromise = null;
                reject(new Error("認証ウィンドウが閉じられました"));
              }
            }
          }, 1000);
        });
      }

      authCallback(event) {
        console.log('Received message event:', {
          origin: event.origin,
          expectedOrigin: window.location.origin,
          data: event.data
        });
        
        if (event.origin !== window.location.origin) {
          console.warn(`Ignored message from different origin: ${event.origin} (expected: ${window.location.origin})`);
          return;
        }
        
        if (event.data && event.data.type === 'authorization_response' && event.data.payload && event.data.payload.token) {
          if (this.checkClosedInterval) {
            clearInterval(this.checkClosedInterval);
            this.checkClosedInterval = null;
          }
          
          this.token = event.data.payload.token;
          console.log('Authentication successful, token received');
          
          if (this.authPromise) {
            this.authPromise(true);
            this.authPromise = null;
          }
          this.cleanup();
        } else {
          console.warn('Invalid message format:', event.data);
        }
      }

      cleanup() {
        if (this.authWindow) {
          this.authWindow.close();
        }
        window.removeEventListener("message", this.authCallback.bind(this));
      }

      async getUser() {
        if (!this.token) {
          console.error("getUser called but no token available");
          throw new Error("Not authenticated");
        }

        console.log("Fetching user info from GitHub API");
        const res = await fetch("https://api.github.com/user", {
          headers: {
            Authorization: `Bearer ${this.token}`,
            Accept: "application/vnd.github.v3+json",
          },
        });

        if (!res.ok) {
          console.error("GitHub API error:", res.status, res.statusText);
          const err = await res.json();
          console.error("GitHub API error details:", err);
          throw err;
        }

        const data = await res.json();
        console.log("User info retrieved:", data.login);
        return {
          name: data.name || data.login,
          login: data.login,
          avatar_url: data.avatar_url,
        };
      }

      logout() {
        this.token = null;
        return Promise.resolve();
      }

      getToken() {
        return Promise.resolve(this.token);
      }
    }

    // Decap CMSが読み込まれるのを待つ
    let cmsInitialized = false;
    let backendRegistered = false;
    
    function waitForCMS() {
      const CMS = window.CMS || window.DecapCMS || window.NETLIFY_CMS;
      
      if (!CMS) {
        console.log('Waiting for Decap CMS...');
        setTimeout(waitForCMS, 100);
        return;
      }
      
      if (cmsInitialized) {
        return; // 既に初期化済みの場合は何もしない
      }
      
      console.log('✓ Decap CMS loaded from CDN');
      console.log('CMS object:', CMS);
      console.log('Available methods:', Object.keys(CMS));
      
      // マウントポイントが存在することを確認
      const mountPoint = document.getElementById('nc-root');
      if (!mountPoint) {
        console.error('✗ Mount point #nc-root not found');
        setTimeout(waitForCMS, 100);
        return;
      }
      
      // マウントポイントをクリア（DOMエラーを回避）
      mountPoint.innerHTML = '';
      
      // カスタムバックエンドを登録（CMS.init()の前に実行する必要がある）
      if (!backendRegistered && typeof CMS.registerBackend === 'function') {
        console.log('Registering custom backend...');
        try {
          CMS.registerBackend("github", CustomAuth);
          backendRegistered = true;
          console.log('✓ Custom backend registered successfully');
        } catch (error) {
          console.error('✗ Failed to register custom backend:', error);
          console.error('Error details:', error.message, error.stack);
        }
      } else if (!backendRegistered) {
        console.warn('⚠ CMS.registerBackend is not available, trying alternative method');
        // 代替方法: CMSオブジェクトに直接設定
        if (CMS.backends) {
          CMS.backends.github = CustomAuth;
          backendRegistered = true;
          console.log('✓ Custom backend registered via alternative method');
        }
      }
      
      // CMS.init()が利用可能になるまで待つ
      if (typeof CMS.init !== 'function') {
        console.log('Waiting for CMS.init...');
        setTimeout(waitForCMS, 100);
        return;
      }
      
      // CMSを初期化
      console.log('Initializing CMS...');
      try {
        const config = {
          backend: {
            name: "github",
            repo: "curokami/blog-project-",
            branch: "main",
            auth_endpoint: "/api/auth"
          },
          media_folder: "public/images",
          public_folder: "/images",
          collections: [
            {
              name: "posts",
              label: "ブログ記事",
              folder: "src/content/posts",
              create: true,
              slug: "{{year}}-{{month}}-{{day}}-{{slug}}",
              fields: [
                { label: "タイトル", name: "title", widget: "string" },
                { label: "公開日", name: "pubDate", widget: "datetime" },
                { label: "著者", name: "author", widget: "string" },
                { label: "概要", name: "description", widget: "text" },
                { label: "画像", name: "image", widget: "image" },
                { label: "タグ", name: "tags", widget: "list", allow_add: true },
                { label: "本文", name: "body", widget: "markdown" }
              ]
            }
          ]
        };
        
        console.log('CMS config:', config);
        CMS.init(config);
        cmsInitialized = true;
        console.log('✓ Decap CMS initialized successfully');
      } catch (error) {
        console.error('✗ Failed to initialize CMS:', error);
        console.error('Error details:', error.message, error.stack);
        // エラーが発生しても再試行しない（無限ループを防ぐ）
        cmsInitialized = true;
      }
    }
    
    // DOMが完全に読み込まれてから初期化を開始
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(waitForCMS, 200);
      });
    } else {
      setTimeout(waitForCMS, 200);
    }
  </script>
</body>
</html>

