---
// src/pages/admin.astro
// Astro公式ドキュメントに基づいた実装: https://docs.astro.build/ja/guides/cms/decap-cms/
---

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Content Manager</title>
  <!-- Decap CMSの設定ファイルを読み込む -->
  <link rel="cms-config-url" href="/admin/config.yml" />
</head>
<body>
  <!-- Decap CMSのマウントポイント -->
  <div id="nc-root"></div>
  
  <!-- Decap CMSスクリプトをCDNから読み込む（公式推奨方法） -->
  <script src="https://unpkg.com/decap-cms@3.3.3/dist/decap-cms.js"></script>
  
  <script>
    // Decap CMSが読み込まれるのを待つ
    function waitForCMS() {
      const CMS = window.CMS || window.DecapCMS || window.NETLIFY_CMS;
      
      if (!CMS) {
        console.log('Waiting for Decap CMS...');
        setTimeout(waitForCMS, 100);
        return;
      }
      
      // マウントポイントが存在することを確認
      const mountPoint = document.getElementById('nc-root');
      if (!mountPoint) {
        console.error('✗ Mount point #nc-root not found');
        setTimeout(waitForCMS, 100);
        return;
      }
      
      // マウントポイントをクリア（DOMエラーを回避）
      mountPoint.innerHTML = '';
      
      // CMS.init()が利用可能になるまで待つ
      if (typeof CMS.init !== 'function') {
        console.log('Waiting for CMS.init...');
        setTimeout(waitForCMS, 100);
        return;
      }
      
      // CMSを初期化
      // config.ymlが自動的に読み込まれるので、CMS.init()を引数なしで呼び出す
      console.log('Initializing CMS...');
      try {
        CMS.init();
        console.log('✓ Decap CMS initialized successfully');
      } catch (error) {
        console.error('✗ Failed to initialize CMS:', error);
        console.error('Error details:', error.message, error.stack);
      }
    }
    
    // DOMが完全に読み込まれてから初期化を開始
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(waitForCMS, 200);
      });
    } else {
      setTimeout(waitForCMS, 200);
    }
  </script>
</body>
</html>
